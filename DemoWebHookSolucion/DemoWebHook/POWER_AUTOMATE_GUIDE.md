# Guía de Integración con Power Automate

## Configuración del Webhook en Power Automate

### Paso 1: Crear el Flujo

1. Ir a [Power Automate](https://make.powerautomate.com)
2. Clic en **Crear** ? **Flujo de nube automatizado**
3. Asignar un nombre: "FileWatcher - Procesamiento de Archivos"
4. Buscar y seleccionar: **"When a HTTP request is received"**
5. Clic en **Crear**

### Paso 2: Configurar el Trigger HTTP

En el trigger "When a HTTP request is received", pegar el siguiente esquema JSON:

```json
{
    "type": "object",
    "properties": {
        "eventType": {
            "type": "string"
        },
        "fullPath": {
            "type": "string"
        },
        "name": {
            "type": "string"
        },
        "oldFullPath": {
            "type": "string"
        },
        "oldName": {
            "type": "string"
        },
        "changeTimeUtc": {
            "type": "string"
        },
        "machineName": {
            "type": "string"
        },
        "watcherConfig": {
            "type": "object",
            "properties": {
                "path": {
                    "type": "string"
                },
                "includeSubdirectories": {
                    "type": "boolean"
                },
                "filter": {
                    "type": "string"
                }
            }
        }
    }
}
```

### Paso 3: Obtener la URL del Webhook

1. **Guardar** el flujo (botón Guardar)
2. Copiar la **HTTP POST URL** que aparece en el trigger
3. Esta URL debe configurarse en el archivo `appsettings.json` de la aplicación

```json
{
  "Webhook": {
    "Url": "PEGAR_AQUÍ_LA_URL_COPIADA"
  }
}
```

---

## Ejemplos de Flujos

### Ejemplo 1: Notificación por Email cuando se crea un archivo

```
???????????????????????????????????????????
? When a HTTP request is received         ?
???????????????????????????????????????????
               ?
               ?
???????????????????????????????????????????
? Condition                                ?
? eventType is equal to "Created"          ?
???????????????????????????????????????????
           ? Yes         ? No
           ?             ?
    ????????????????   ????????????????
    ? Send email   ?   ? (Terminate)  ?
    ?              ?   ????????????????
    ? To: admin@   ?
    ? Subject:     ?
    ? New file     ?
    ? created      ?
    ????????????????
```

**Configuración del Email:**
- **Para:** admin@miempresa.com
- **Asunto:** Nuevo archivo creado: `[name]`
- **Cuerpo:**
```
Se ha creado un nuevo archivo en el sistema:

Archivo: [name]
Ruta completa: [fullPath]
Fecha/Hora: [changeTimeUtc]
Servidor: [machineName]
Carpeta vigilada: [watcherConfig.path]
```

---

### Ejemplo 2: Registrar en SharePoint List

```
???????????????????????????????????????????
? When a HTTP request is received         ?
???????????????????????????????????????????
               ?
               ?
???????????????????????????????????????????
? Create item (SharePoint)                ?
?                                          ?
? Site: https://miempresa.sharepoint.com  ?
? List: "Registro de Archivos"            ?
?                                          ?
? Fields:                                  ?
? - EventType: eventType                   ?
? - FileName: name                         ?
? - FullPath: fullPath                     ?
? - ChangeDate: changeTimeUtc              ?
? - MachineName: machineName               ?
???????????????????????????????????????????
```

**Lista de SharePoint - Columnas sugeridas:**
- EventType (Single line of text)
- FileName (Single line of text)
- FullPath (Multiple lines of text)
- ChangeDate (Date and Time)
- MachineName (Single line of text)

---

### Ejemplo 3: Copiar archivo a SharePoint cuando se crea un PDF

```
???????????????????????????????????????????
? When a HTTP request is received         ?
???????????????????????????????????????????
               ?
               ?
???????????????????????????????????????????
? Condition                                ?
? eventType equals "Created"               ?
? AND                                      ?
? name endsWith ".pdf"                     ?
???????????????????????????????????????????
           ? Yes         ? No
           ?             ?
    ????????????????   ????????????????
    ? Get file     ?   ? (Terminate)  ?
    ? content      ?   ????????????????
    ? from path    ?
    ????????????????
           ?
           ?
    ????????????????????????????
    ? Create file (SharePoint) ?
    ?                          ?
    ? Site: https://...        ?
    ? Folder: /Documentos      ?
    ? File Name: name          ?
    ? File Content: [binary]   ?
    ????????????????????????????
           ?
           ?
    ????????????????
    ? Send email   ?
    ? notification ?
    ????????????????
```

**Nota:** Para leer el contenido del archivo, usar el conector **File System** con una cuenta que tenga permisos.

---

### Ejemplo 4: Procesamiento condicional por tipo de evento

```
???????????????????????????????????????????
? When a HTTP request is received         ?
???????????????????????????????????????????
               ?
               ?
???????????????????????????????????????????
? Switch (eventType)                       ?
?????????????????????????????????????????
   ?    ?    ?    ?
   ?    ?    ?    ??? Default
   ?    ?    ?         (Log only)
   ?    ?    ?
   ?    ?    ??? Deleted
   ?    ?         ??? Log to SharePoint
   ?    ?         ??? Alert admin
   ?    ?
   ?    ??? Renamed
   ?         ??? Update database
   ?         ??? Log change
   ?
   ??? Created
        ??? Validate file
        ??? Move to SharePoint
        ??? Notify team
```

---

### Ejemplo 5: Integración con Teams

```
???????????????????????????????????????????
? When a HTTP request is received         ?
???????????????????????????????????????????
               ?
               ?
???????????????????????????????????????????
? Post adaptive card in a chat or channel ?
?                                          ?
? Team: Mi Equipo                          ?
? Channel: General                         ?
?                                          ?
? Card:                                    ?
? ??????????????????????????????          ?
? ? ?? Nuevo archivo detectado ?          ?
? ?                            ?          ?
? ? Tipo: [eventType]          ?          ?
? ? Archivo: [name]            ?          ?
? ? Ruta: [fullPath]           ?          ?
? ? Servidor: [machineName]    ?          ?
? ??????????????????????????????          ?
???????????????????????????????????????????
```

---

### Ejemplo 6: Workflow de aprobación

```
???????????????????????????????????????????
? When a HTTP request is received         ?
???????????????????????????????????????????
               ?
               ?
???????????????????????????????????????????
? Condition: eventType = "Created"        ?
? AND name contains "FACTURA"              ?
???????????????????????????????????????????
           ? Yes         ? No
           ?             ??? (End)
???????????????????????????????????????????
? Start and wait for an approval           ?
?                                          ?
? Approval type: Approve/Reject - First   ?
? Title: Nueva factura requiere aprobación?
? Assigned to: gerencia@miempresa.com     ?
? Details:                                 ?
?   Archivo: [name]                        ?
?   Ubicación: [fullPath]                  ?
???????????????????????????????????????????
           ? Approved    ? Rejected
           ?             ?
    ????????????   ????????????
    ? Move to  ?   ? Move to  ?
    ? Approved ?   ? Rejected ?
    ? folder   ?   ? folder   ?
    ????????????   ????????????
```

---

## Variables Dinámicas Disponibles

En cualquier acción del flujo, puedes usar estas variables del trigger:

| Variable | Descripción | Ejemplo |
|----------|-------------|---------|
| `eventType` | Tipo de evento | "Created", "Changed", "Deleted", "Renamed" |
| `fullPath` | Ruta completa del archivo | "C:\temp\watch\documento.pdf" |
| `name` | Nombre del archivo | "documento.pdf" |
| `oldFullPath` | Ruta antigua (solo Renamed) | "C:\temp\watch\viejo.pdf" |
| `oldName` | Nombre antiguo (solo Renamed) | "viejo.pdf" |
| `changeTimeUtc` | Fecha/hora del cambio (UTC) | "2025-01-13T10:30:45Z" |
| `machineName` | Nombre del servidor | "SERVIDOR-01" |
| `watcherConfig/path` | Carpeta vigilada | "C:\temp\watch" |
| `watcherConfig/includeSubdirectories` | ¿Incluye subdirectorios? | true |
| `watcherConfig/filter` | Filtro de archivos | "*.pdf" |

---

## Expresiones Útiles

### Extraer extensión del archivo
```
last(split(triggerBody()?['name'], '.'))
```

### Convertir fecha UTC a local
```
convertFromUtc(triggerBody()?['changeTimeUtc'], 'Romance Standard Time')
```

### Obtener solo el nombre del directorio padre
```
last(split(triggerBody()?['watcherConfig']?['path'], '\'))
```

### Condición: solo PDFs
```
endsWith(triggerBody()?['name'], '.pdf')
```

### Condición: solo archivos grandes
Para esto necesitarías agregar lógica adicional para obtener el tamaño del archivo usando File System connector.

---

## Mejores Prácticas

### 1. **Manejo de Errores**
Agregar scope "Try-Catch" para manejar errores:

```
Scope (Try)
??? [Tus acciones]
?
Scope (Catch)
??? Run after: has failed
    ??? Send error notification
    ??? Log to SharePoint/Table
```

### 2. **Validaciones**
- Verificar que el archivo existe antes de procesarlo
- Validar extensiones permitidas
- Comprobar tamaño de archivo
- Verificar permisos

### 3. **Performance**
- Usar condiciones tempranas para filtrar eventos no deseados
- Considerar "Concurrency Control" en el trigger
- Para alto volumen, considerar Azure Functions en lugar de Power Automate

### 4. **Seguridad**
- No exponer rutas completas en notificaciones públicas
- Usar permisos mínimos necesarios
- Considerar agregar autenticación adicional en el webhook (header personalizado)

### 5. **Logging y Auditoría**
- Registrar todos los eventos en una lista o base de datos
- Mantener historial de procesamiento
- Configurar alertas para errores recurrentes

---

## Troubleshooting

### El flujo no se dispara
- Verificar que la URL del webhook es correcta en appsettings.json
- Revisar logs de la aplicación FileWatcher
- Comprobar que el flujo está activado (On)

### Errores 400 Bad Request
- Verificar que el esquema JSON del trigger coincide con el payload
- Revisar que todos los campos requeridos están presentes

### Timeouts
- Aumentar `TimeoutSeconds` en appsettings.json
- Simplificar el flujo de Power Automate
- Considerar hacer el flujo asíncrono (responder 200 inmediatamente y procesar después)

---

## Ejemplo Completo: Flujo JSON

Aquí hay un ejemplo de flujo completo que puedes importar:

```json
{
  "definition": {
    "triggers": {
      "manual": {
        "type": "Request",
        "kind": "Http",
        "inputs": {
          "schema": {
            "type": "object",
            "properties": {
              "eventType": { "type": "string" },
              "fullPath": { "type": "string" },
              "name": { "type": "string" },
              "changeTimeUtc": { "type": "string" },
              "machineName": { "type": "string" }
            }
          }
        }
      }
    },
    "actions": {
      "Condition": {
        "type": "If",
        "expression": {
          "equals": ["@triggerBody()?['eventType']", "Created"]
        },
        "actions": {
          "Send_email": {
            "type": "ApiConnection",
            "inputs": {
              "host": {
                "connection": {
                  "name": "@parameters('$connections')['office365']['connectionId']"
                }
              },
              "method": "post",
              "path": "/v2/Mail",
              "body": {
                "To": "admin@miempresa.com",
                "Subject": "Nuevo archivo: @{triggerBody()?['name']}",
                "Body": "<p>Se creó un archivo nuevo:<br>Nombre: @{triggerBody()?['name']}<br>Ruta: @{triggerBody()?['fullPath']}</p>"
              }
            }
          }
        }
      }
    }
  }
}
```

---

## Recursos Adicionales

- [Documentación de Power Automate HTTP Trigger](https://learn.microsoft.com/en-us/power-automate/triggers-introduction)
- [Expresiones en Power Automate](https://learn.microsoft.com/en-us/power-automate/use-expressions-in-conditions)
- [Conectores de Power Automate](https://learn.microsoft.com/en-us/connectors/)
